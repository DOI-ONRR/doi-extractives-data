{"version":3,"sources":["webpack:///webpack/bootstrap 7c87a74a1c14364e3857?1a87****","webpack:///./js/pages/company-revenue.js","webpack:///./js/src/company-revenue.js","webpack:///./js/eiti.explore.js?ac3c"],"names":[],"mappings":";AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA,mDAA2C,cAAc;;AAEzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;;;;;;;;;;;;;AChEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,OAAO;;AAEP;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA,OAAO;;AAEP;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;AACA,OAAO;;AAEP;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;;AAEP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,CAAC;;;;;;;;;;;;;;ACpWD;;AAEA;AACA;;;;;;;;;;;;;ACHA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,eAAe,EAAE;AACjB;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,eAAe,OAAO;AACtB;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,wBAAwB;AACxB;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA;AACA,OAAO;;AAEP;AACA;;AAEA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;;AAEA,mBAAmB;AACnB;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA,SAAS;;AAET;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;;AAEA;AACA;AACA;AACA;AACA,SAAS;;AAET;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA,CAAC","file":"company-revenue.min.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 39);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 7c87a74a1c14364e3857","/* global d3, eiti */\n(function() {\n  'use strict';\n\n  var root = d3.select('#companies');\n  var revenueTypeList = root.select('#revenue-types');\n  var companyList = root.select('#companies');\n\n  var WITHHELD = 'Withheld';\n\n  var getter = eiti.data.getter;\n  var grouper;\n  var formatDollars = eiti.format('$,.0f');\n  var formatNumber = function(n) {\n    return n === WITHHELD ? n : formatDollars(n);\n  };\n  var REVENUE_TYPE_PREFIX = /^[A-Z]+(\\/[A-Z]+)?\\s+-\\s+/;\n\n  var sumRevenue = function(data) {\n    var withheld = 0;\n    return d3.sum(data, function(d) {\n      if (d.Revenue === WITHHELD) {\n        withheld++;\n        return 0;\n      }\n      return d.Revenue;\n    }) || (withheld === data.length ? WITHHELD : 0);\n  };\n\n  var state = eiti.explore.stateManager()\n    .on('change', update);\n\n  var hash = eiti.explore.hash()\n    .on('change', state.merge);\n\n  // buttons that expand and collapse other elements\n  var filterToggle = root.select('button.toggle-filters');\n\n  // FIXME: componentize these too\n  var filterParts = root.selectAll('a[data-key]');\n  filterParts.on('click', function(e, index) {\n    var key = filterParts[0][index].getAttribute('data-key');\n    if (key) {\n      root.select('.filters-wrapper').attr('aria-expanded', true);\n      filterToggle.attr('aria-expanded', true);\n      root.select('.filter-description_closed').attr('aria-expanded', true);\n      document.querySelector('#'+ key + '-selector').focus();\n    }\n    d3.event.preventDefault();\n  });\n\n  var year = root.attr('data-year');\n  if (!year) {\n    throw new Error('No year found in', root.node());\n  }\n  var dataUrl = '../../../data/company-revenue/output/' + year + '.tsv';\n\n  var model = eiti.explore.model(dataUrl)\n    .transform(removeRevenueTypePrefix)\n    .filter('commodity', function(data, commodity) {\n      return data.filter(function(d) {\n        return d.Commodity === commodity;\n      });\n    })\n    .filter('type', function(data, type) {\n      return data.filter(function(d) {\n        return d.revenueType === type;\n      });\n    })\n    .on('prefilter', function(key, data) {\n      if (key === 'commodity') {\n        updateCommoditySelector(data);\n        updateRevenueTypeSelector(data);\n      }\n    });\n\n  var filters = root.selectAll('.filters [name]')\n    .on('change', filterChange);\n\n  var search = root.select('#company-name-filter')\n    .on('keyup', updateNameSearch)\n    .on('clear', filterChange)\n    .on('change', filterChange);\n\n  var initialState = hash.read();\n  var innerKey = 'revenueType';\n\n  var withheldComparator = function(key) {\n    var get = getter(key);\n    return function(a, b) {\n      var aa = get(a);\n      var bb = get(b);\n      if (aa === WITHHELD) {\n        return 1;\n      } else if (bb === WITHHELD) {\n        return -1;\n      }\n      return d3.descending(+aa, +bb);\n    };\n  };\n\n  state.init(initialState);\n\n  function update(state) {\n    var query = state.toJS();\n    hash.write(query);\n\n    updateFilterDescription(state);\n\n    grouper = d3.nest()\n      .rollup(sumRevenue)\n      .sortValues(withheldComparator('Revenue'));\n\n    var hasCommodity = !!query.commodity;\n    var hasType = !!query.type;\n    if (hasType && !hasCommodity) {\n      innerKey = 'Commodity';\n    } else {\n      innerKey = 'revenueType';\n    }\n    grouper.key(getter(innerKey));\n\n    model.load(state, function(error, data) {\n      if (error) {\n        // console.error('error:', error);\n        data = [];\n      }\n\n      filters.each(function() {\n        this.value = state.get(this.name) || '';\n      });\n\n      search.property('value', state.get('search') || '');\n      render(data);\n    });\n  }\n\n  function render(data) {\n    // console.log('rendering %d rows', data.length, data[0]);\n    updateRevenueTypes(data);\n    updateCompanyList(data);\n    updateNameSearch();\n  }\n\n  function updateCommoditySelector(data) {\n    var commodities = d3.nest()\n      .key(getter('Commodity'))\n      .entries(data)\n      .map(getter('key'))\n      .sort(d3.ascending);\n    var input = root.select('#commodity-selector');\n    var options = input.selectAll('option.value')\n      .data(commodities, identity);\n    options.enter().append('option')\n      .attr('class', 'value')\n      .attr('value', identity)\n      .text(identity);\n  }\n\n  function updateRevenueTypeSelector(data) {\n    var commodities = d3.nest()\n      .key(getter('revenueType'))\n      .entries(data)\n      .map(getter('key'))\n      .sort(d3.ascending);\n    var input = root.select('#type-selector');\n    var options = input.selectAll('option.value')\n      .data(commodities, identity);\n    options.enter().append('option')\n      .attr('class', 'value')\n      .attr('value', identity)\n      .text(identity);\n  }\n\n  function updateRevenueTypes(data) {\n    var types = grouper.entries(data)\n      .map(function(d) {\n        return {\n          name: d.key,\n          value: d.values\n        };\n      });\n\n    var extent = d3.extent(types, getter('value'));\n    revenueTypeList.call(renderSubtypes, types, extent);\n  }\n\n  function updateCompanyList(data) {\n    var companies = d3.nest()\n      .key(getter('Company'))\n      .entries(data)\n      .map(function(d) {\n        var total = sumRevenue(d.values);\n        return {\n          name: d.key,\n          total: total,\n          types: grouper.entries(d.values)\n            .map(function(d) {\n              return {\n                name: d.key,\n                value: d.values\n              };\n            })\n        };\n      });\n\n    var items = companyList.selectAll('tbody.company')\n      .data(companies, getter('name'));\n\n    items.exit().remove();\n\n    var enter = items.enter().append('tbody')\n      .attr('class', 'company subgroup')\n      .append('tr')\n        .attr('class', 'name');\n    enter.append('td')\n      .attr('class', 'subregion-name')\n      .text(getter('name'));\n    enter.append('td')\n      .attr('class', 'subtotal value');\n    enter.append('td')\n      .attr('class', 'subtotal-label');\n\n    items.sort(function(a, b) {\n      return d3.descending(a.total, b.total);\n    });\n\n    items.select('.subtotal-label')\n      .text(function(d) {\n        return d.types.length > 1 ? 'total' : '';\n      });\n\n    items.select('.subtotal')\n      .text(function(d) {\n        return d.types.length > 1 ? formatNumber(d.total) : '';\n      });\n\n    var extent = d3.extent(companies, getter('total'));\n    items.call(renderSubtypes, getter('types'), extent);\n  }\n\n  function renderSubtypes(selection, types, extent) {\n    var items = selection.selectAll('.subtype')\n      .data(types, getter('name'));\n\n    items.exit().remove();\n    items.enter().append('tr')\n      .attr('class', 'subtype')\n      .call(setupRevenueItem);\n\n    items\n      .call(updateRevenueItem, extent)\n\n    selection.each(function() {\n      d3.select(this)\n        .selectAll('tr.subtype')\n          .sort(withheldComparator('value'));\n    });\n  }\n\n  function updateNameSearch() {\n    var query = search.property('value').toLowerCase();\n    var items = companyList.selectAll('.company');\n    if (query) {\n      items\n        .style('display', function(d) {\n          d.index = d.name.toLowerCase().indexOf(query)\n          return d.index > -1 ? null : 'none';\n        })\n        .filter(function(d) {\n          return d.index > -1;\n        })\n        .select('.subregion-name')\n          .html(function(d) {\n            var name = d.name;\n            var start = d.index;\n            var end = d.index + query.length;\n            return [\n              name.substr(0, start),\n              '<span class=\"hilite\">',\n              name.substr(start, query.length),\n              '</span>',\n              name.substr(end)\n            ].join('');\n          });\n    } else {\n      items\n        .style('display', null)\n        .select('.subregion-name')\n          .text(getter('name'));\n    }\n  }\n\n  function setupRevenueItem(selection) {\n    selection.append('td')\n      .attr('class', 'name');\n    selection.append('td')\n      .attr('class', 'value');\n    selection.append('td')\n      .attr('class', 'bar')\n      .append('eiti-bar');\n  }\n\n  function updateRevenueItem(selection, extent) {\n    selection.select('.name')\n      .text(getter('name'));\n\n    selection.select('.value')\n      .text(function(d) {\n        return formatNumber(d.value);\n      });\n\n    var bar = selection.select('eiti-bar')\n      .attr('value', getter('value'));\n\n    if (extent) {\n      bar\n        .attr('min', Math.min(0, extent[0]))\n        .attr('max', extent[1]);\n    }\n  }\n\n  function updateFilterDescription(state) {\n    var desc = root.selectAll('[data-filter-description]');\n\n    var data = {\n      type: state.get('type') || 'All revenue',\n      commodity: (state.get('commodity') || 'all resource').toLowerCase(),\n    };\n\n    /*\n    if (data.commodity === 'N/A') {\n      data.commodity = 'no applicable';\n    }\n    */\n\n    desc.selectAll('[data-key]')\n      .text(function() {\n        return data[this.getAttribute('data-key')];\n      });\n  }\n\n  function removeRevenueTypePrefix(row) {\n    if (!row.revenueType) {\n      row.revenueType = row['Revenue Type'].replace(REVENUE_TYPE_PREFIX, '');\n    }\n  }\n\n  function filterChange() {\n    state.set(this.name, this.value);\n  }\n\n  function identity(d) {\n    return d;\n  }\n\n})(this);\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./js/pages/company-revenue.js\n// module id = 32\n// module chunks = 5","'use strict';\n\nrequire('./../eiti.explore.js');\nrequire('./../pages/company-revenue.js');\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./js/src/company-revenue.js\n// module id = 39\n// module chunks = 5","/* global d3, eiti, Immutable */\n(function(eiti) {\n  'use strict';\n\n  eiti.explore = {};\n\n  /**\n   * @class stateManager\n   * The state manager helps you manage application state, using an\n   * Immutable.Map under the hood.\n   *\n   * @example\n   * var manager = eiti.explore.stateManager()\n   *   .on('change', function(state) {\n   *   })\n   *   .set('foo', 'bar');\n   */\n  eiti.explore.stateManager = function() {\n\n    var state = new Immutable.Map();\n    var updated = false;\n\n    var manager = {};\n    var dispatch = d3.dispatch('change');\n\n    // the default state validator is a noop\n    var validateState = function(state) {\n      return state;\n    };\n\n    /**\n     * Raw state mutation with a function, which should take an\n     * Immutable.Map and return either the same one or a mutated\n     * instance:\n     *\n     * @example\n     * manager.mutate(function(state) {\n     *   return state.set('x', 1);\n     * });\n     *\n     * @param Function mutator\n     */\n    manager.mutate = function(fn) {\n      mutateState(fn);\n      return manager;\n    };\n\n    /**\n     * set a single key\n     * @param String key\n     * @param {*} value\n     */\n    manager.set = function(key, value) {\n      mutateState(function(state) {\n        return state.set(key, value);\n      });\n      return manager;\n    };\n\n    /**\n     * merge the keys of the provided object\n     * @param Object keys\n     */\n    manager.merge = function(keys) {\n      mergeState(keys);\n      return manager;\n    };\n\n    /**\n     * Provide a validation function for your state before 'change'\n     * events are updated. This should return an Immutable.Map, e.g.\n     *\n     * @example\n     * manager.validate(function(state) {\n     *   if (!state.has('foo')) {\n     *     return state.set('foo', 'default foo');\n     *   }\n     *   return state;\n     * });\n     *\n     * @param Function validator\n     */\n    manager.validate = function(validator) {\n      validateState = validator;\n      return manager;\n    };\n\n    /**\n     * Initialize the manager state with an optional Object literal.\n     *\n     * @param {Object}? initial\n     */\n    manager.init = function(initial) {\n      var previous = state;\n      if (initial) {\n        // eslint-disable-next-line no-unused-expressions\n        mergeState(initial) || update(state, previous);\n      } else {\n        update(state, null);\n      }\n      return manager;\n    };\n\n    function update(state, previous) {\n      dispatch.change(state, previous, updated);\n      updated = true;\n    }\n\n    // mutate the state and update if the state has changed\n    function mutateState(fn) {\n      var previous = state;\n      state = fn(state) || new Immutable.Map();\n      if (!Immutable.is(state, previous)) {\n        state = validateState(state, previous, updated);\n        update(state, previous);\n        return true;\n      }\n      return false;\n    }\n\n    function mergeState(keys) {\n      return mutateState(function(state) {\n        return state.merge(keys);\n      });\n    }\n\n    return d3.rebind(manager, dispatch, 'on');\n  };\n\n  eiti.explore.hash = function() {\n    var dispatch = d3.dispatch('change');\n\n    var hash = {};\n    var writing = false;\n\n    hash.read = function() {\n      if (!location.hash) {\n        return {};\n      }\n      var str = location.hash.substr(1);\n      return eiti.url.qs.parse(str);\n    };\n\n    hash.write = function(data) {\n      writing = true;\n      location.hash = data ? eiti.url.qs.format(data) : '';\n      writing = false;\n    };\n\n    function change(e) { // eslint-disable-line no-unused-vars\n      if (writing) {\n        return;\n      }\n      dispatch.change(hash.read());\n    }\n\n    window.addEventListener('hashchange', change);\n\n    return d3.rebind(hash, dispatch, 'on');\n  };\n\n  eiti.explore.model = function(url) {\n    var model = {};\n    var dispatch = d3.dispatch('prefilter', 'postfilter');\n    var getDataURL = d3.functor(url);\n    var transform;\n    var req;\n\n    var filters = [];\n\n    model.load = function(state, done) {\n      if (req) {\n        req.abort();\n      }\n      var url = getDataURL(state);\n      // console.log('model.load():', url);\n      req = eiti.load(url, function(error, data) {\n        if (error) {\n          data = [];\n        }\n        if (transform) {\n          data.forEach(transform);\n        }\n        applyFilters(data, state, done);\n      });\n      return req;\n    };\n\n    model.filter = function(stateKey, filter) {\n      filters.push({\n        key: stateKey,\n        func: filter\n      });\n      return model;\n    };\n\n    model.transform = function(fn) {\n      if (arguments.length) {\n        transform = fn;\n        return model;\n      }\n      return transform;\n    };\n\n    function applyFilters(data, state, done) {\n      filters.forEach(function(filter) {\n        var value = state.get(filter.key);\n        dispatch.prefilter(filter.key, data);\n        if (value || value === 0) { // XXX\n          data = filter.func(data, value, filter.key);\n          dispatch.postfilter(filter.key, data);\n        }\n      });\n\n      done(null, data);\n    }\n\n    return d3.rebind(model, dispatch, 'on');\n  };\n\n\n  eiti.explore.timeline = function() {\n    var getter = eiti.data.getter;\n    var value = getter('value');\n    var aggregate;\n\n    var years = [];\n    var selected;\n\n    var timeline = function(selection, data) {\n      var rollup = aggregate || function(d) {\n        return d3.sum(d, value);\n      };\n\n      var dataByYearPolarity = d3.nest()\n        .key(function(d) {\n          return value(d) < 0 ? 'negative' : 'positive';\n        })\n        .key(getter('Year'))\n        .rollup(rollup)\n        .map(data);\n\n      // console.log('data by year/polarity:', dataByYearPolarity);\n      var positiveYears = dataByYearPolarity.positive || {};\n      var positiveExtent = d3.extent(d3.values(positiveYears));\n      var negativeYears = dataByYearPolarity.negative || {};\n      var negativeExtent = d3.extent(d3.values(negativeYears));\n\n      var w = 500;\n      var h = 40;\n      var viewBox = selection.attr('viewBox');\n      // if there is a viewBox already, derive the dimensions from it\n      if (viewBox) {\n        viewBox = viewBox.split(' ').map(Number);\n        w = viewBox[2];\n        h = viewBox[3];\n      } else {\n        // otherwise, set up the viewBox with our default dimensions\n        selection.attr('viewBox', [0, 0, w, h].join(' '));\n      }\n\n      var left = 0; // XXX need to make room for axis labels\n      var right = w;\n\n      // the x-axis scale\n      var x = d3.scale.linear()\n        .domain(d3.extent(years))\n        .range([left, right + 2]);\n\n      // the y-axis domain sets a specific point for zero.\n      // the `|| -100` and `|| 100` bits here ensure that the domain has some\n      // size, even if there is no data from which to derive an extent.\n      var yDomain = [\n        negativeExtent[0] || 0,\n        positiveExtent[1] || 100\n      ];\n      // the y-axis scale, with the zero point at 3/4 the height\n      // XXX: note that this exaggerates the negative scale!\n      var y = d3.scale.linear()\n        .domain(yDomain)\n        .range([h, 0]);\n\n      var area = d3.svg.area()\n        .interpolate('step-after')\n        .x(function(d) {\n          return x(d.year);\n        })\n        .y0(y(0))\n        .y1(function(d) {\n          return y(d.value);\n        });\n\n      var areas = selection.selectAll('path.area')\n        .data([\n          {\n            polarity: 'positive',\n            values: years.map(function(year) {\n              return {\n                year: year,\n                value: positiveYears[year] || 0\n              };\n            })\n          },\n          {\n            polarity: 'negative',\n            values: years.map(function(year) {\n              return {\n                year: year,\n                value: negativeYears[year] || 0\n              };\n            })\n          }\n        ]);\n\n      areas.exit().remove();\n      areas.enter().append('path')\n        .attr('class', function(d) {\n          return 'area ' + d.polarity;\n        });\n\n      var zero = selection.select('g.zero');\n      if (zero.empty()) {\n        zero = selection.append('g')\n          .attr('class', 'zero');\n        zero.append('line');\n        zero.append('text')\n          .attr('class', 'label')\n          .attr('text-anchor', 'end')\n          .attr('dy', 0.5);\n          // .text(0);\n      }\n\n      var mask = selection.select('g.mask');\n      if (mask.empty()) {\n        mask = selection.append('g')\n          .attr('class', 'mask');\n        mask.append('rect')\n          .attr('class', 'before')\n          .attr('x', 0)\n          .attr('width', 0)\n          .attr('height', h);\n        mask.append('rect')\n          .attr('class', 'after')\n          .attr('x', w)\n          .attr('width', w)\n          .attr('height', h);\n        mask.append('line')\n          .attr('class', 'before')\n          .attr('y1', 0)\n          .attr('y2', h);\n        mask.append('line')\n          .attr('class', 'after')\n          .attr('y1', 0)\n          .attr('y2', h);\n      }\n\n      var updated = selection.property('updated');\n      var t = function(d) {\n        return d;\n      };\n      if (updated) {\n        t = function(d) {\n          return d.transition()\n            .duration(500);\n        };\n      }\n\n      var year1 = selected || years[years.length - 1];\n      var year2 = year1 + 1;\n\n      var beforeX = x(year1);\n      var afterX = Math.min(x(year2), w);\n      // don't transition these\n      mask.select('rect.before')\n        .attr('width', beforeX);\n      mask.select('rect.after')\n        .attr('x', afterX);\n      mask.select('line.before')\n        .attr('transform', 'translate(' + [beforeX, 0] + ')');\n      mask.select('line.after')\n        .attr('transform', 'translate(' + [afterX, 0] + ')');\n\n      // transition these\n      // mask = t(mask);\n      mask.selectAll('line')\n        .attr('y1', y(positiveYears[year1] || 0))\n        .attr('y2', y(negativeYears[year1] || 0));\n\n      zero.select('line')\n        .attr('x1', left)\n        .attr('x2', right);\n\n      zero.select('.label')\n        .attr('transform', 'translate(' + [left, 0] + ')');\n\n      t(zero).attr('transform', 'translate(' + [0, y(0)] + ')');\n\n      t(areas).attr('d', function(d) {\n        return area(d.values);\n      });\n      selection.property('updated', true);\n    };\n\n    timeline.selected = function(year) {\n      if (arguments.length) {\n        selected = year;\n        return timeline;\n      }\n      return selected;\n    };\n\n    timeline.years = function(list) {\n      if (arguments.length) {\n        years = list;\n        return timeline;\n      }\n      return years;\n    };\n\n    timeline.value = function(fn) {\n      if (arguments.length) {\n        value = fn || identity;\n        return timeline;\n      }\n      return value;\n    };\n\n    timeline.aggregate = function(fn) {\n      if (arguments.length) {\n        aggregate = fn;\n        return timeline;\n      }\n      return aggregate;\n    };\n\n    return timeline;\n  };\n\n  function identity(d) {\n    return d;\n  }\n\n})(eiti);\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./js/eiti.explore.js\n// module id = 8\n// module chunks = 4 5"],"sourceRoot":""}